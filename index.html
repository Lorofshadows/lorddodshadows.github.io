<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Отправка фото и IP в Telegram</title>
</head>
<body>
  <h2>Введите данные для отправки</h2>
  <form id="telegramForm">
    <label>
      Токен бота Telegram:<br />
      <input type="text" id="token" required style="width: 300px" />
    </label><br /><br />
    <label>
      Chat ID:<br />
      <input type="text" id="chatId" required style="width: 300px" />
    </label><br /><br />
    <button type="submit">Сделать фото и отправить</button>
  </form>
  <p id="status"></p>

  <script>
    document.getElementById('telegramForm').addEventListener('submit', async e => {
      e.preventDefault();

      const status = document.getElementById('status');
      status.textContent = 'Получаем IP...';

      const token = document.getElementById('token').value.trim();
      const chatId = document.getElementById('chatId').value.trim();

      if (!token || !chatId) {
        status.textContent = 'Пожалуйста, заполните все поля.';
        return;
      }

      try {
        // Получаем IP
        const ipRes = await fetch('https://api.ipify.org?format=json');
        const ipJson = await ipRes.json();
        const ip = ipJson.ip;

        status.textContent = 'Получаем доступ к камере...';

        // Доступ к камере
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.createElement('video');
        video.srcObject = stream;
        await video.play();

        // Ждем пока видео будет готово
        await new Promise(resolve => {
          if (video.readyState >= 3) resolve();
          else video.oncanplay = resolve;
        });

        // Захватываем кадр с камеры
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Останавливаем камеру
        stream.getTracks().forEach(track => track.stop());

        status.textContent = 'Формируем файл фото...';

        // Получаем blob jpg
        const photoBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));

        // Формируем форму для отправки в Telegram
        const formData = new FormData();
        formData.append('chat_id', chatId);
        formData.append('photo', photoBlob, 'photo.jpg');
        formData.append('caption', `IP пользователя: ${ip}`);

        status.textContent = 'Отправляем фото в Telegram...';

        // Отправляем запрос в Telegram Bot API
        const response = await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.ok) {
          status.textContent = 'Фото и IP успешно отправлены!';
        } else {
          status.textContent = `Ошибка отправки: ${data.description || 'неизвестная ошибка'}`;
        }

      } catch (err) {
        status.textContent = 'Ошибка: ' + err.message;
      }
    });
  </script>
</body>
</html>
